# Rust Module Configuration for Nginx
# This file configures the Rust-based modules for high-performance video streaming

# Rust Module Path
rust_load_module /usr/lib/nginx/modules/ngx_http_rust_module.so;

# Rust Shared Library Path
rust_shared_lib /usr/lib/nginx/modules/libnginx_rust.so;

# Rust Worker Configuration
rust_worker_threads 4;

# Rust Memory Settings
rust_worker_max_memory 512M;
rust_worker_max_heap_size 256M;

# Rust Module Configuration for Video Processing
rust_module video_processor {
    # Video Processing Configuration
    video_upload_path /var/www/uploads;
    video_temp_path /tmp/nginx_video;
    video_output_path /var/www/processed;
    
    # Video Processing Settings
    video_max_size 4G;
    video_max_duration 3600; # 1 hour in seconds
    video_supported_formats mp4,webm,avi,mov,flv;
    
    # Video Quality Profiles
    video_profiles {
        "1080p" {
            resolution "1920x1080";
            bitrate "5000k";
            framerate "30";
        }
        "720p" {
            resolution "1280x720";
            bitrate "2500k";
            framerate "30";
        }
        "480p" {
            resolution "854x480";
            bitrate "1000k";
            framerate "30";
        }
        "360p" {
            resolution "640x360";
            bitrate "500k";
            framerate "30";
        }
    }
    
    # Audio Processing Settings
    audio_bitrate "128k";
    audio_sample_rate "44100";
    audio_channels "2";
    
    # Thumbnail Generation
    thumbnail {
        sizes {
            "large" "640x360";
            "medium" "320x180";
            "small" "160x90";
        }
        quality "80";
        format "jpg";
    }
    
    # HLS/DASH Manifest Generation
    manifest {
        hls {
            segment_duration "6";
            playlist_length "60";
            encryption false;
        }
        dash {
            segment_duration "6";
            encryption false;
        }
    }
}

# Rust Module Configuration for Caching
rust_module cache_manager {
    # Cache Settings
    cache_enabled true;
    cache_path /var/cache/nginx/rust_cache;
    cache_levels "1:2";
    cache_keys_zone "rust_cache_zone:10m";
    cache_inactive "60m";
    cache_use_temp_path off;
    
    # Cache Rules for Video Content
    cache_rules {
        "/video/" {
            expires "1y";
            cache_valid "200 302 10m";
            cache_valid "301 1h";
            cache_valid "404 1m";
            no_cache "$cookie_session";
        }
        "/hls/" {
            expires "1h";
            cache_valid "200 302 10m";
            cache_valid "404 1m";
            no_cache "$cookie_session";
        }
        "/dash/" {
            expires "1h";
            cache_valid "200 302 10m";
            cache_valid "404 1m";
            no_cache "$cookie_session";
        }
        "/thumbnail/" {
            expires "1y";
            cache_valid "200 302 1h";
            cache_valid "404 1m";
        }
    }
}

# Rust Module Configuration for Rate Limiting
rust_module rate_limiter {
    # Rate Limiting Settings
    enabled true;
    
    # API Rate Limiting
    api {
        zone "api_limit";
        rate "10r/s";
        burst "20";
        nodelay true;
        key "$binary_remote_addr";
    }
    
    # Upload Rate Limiting
    upload {
        zone "upload_limit";
        rate "1r/s";
        burst "5";
        nodelay true;
        key "$binary_remote_addr";
    }
    
    # Download Rate Limiting
    download {
        zone "download_limit";
        rate "100r/s";
        burst "500";
        nodelay true;
        key "$binary_remote_addr";
    }
    
    # Live Stream Rate Limiting
    livestream {
        zone "livestream_limit";
        rate "50r/s";
        burst "200";
        nodelay true;
        key "$binary_remote_addr";
    }
}

# Rust Module Configuration for Security
rust_module security {
    # Security Settings
    enabled true;
    
    # DDoS Protection
    ddos_protection {
        enabled true;
        max_requests_per_second "1000";
        max_connections_per_ip "100";
        ban_duration "1h";
    }
    
    # Bot Detection
    bot_detection {
        enabled true;
        user_agent_blacklist "bot,crawler,spider";
        request_threshold "100";
        ban_duration "24h";
    }
    
    # SQL Injection Protection
    sql_injection_protection {
        enabled true;
        patterns {
            "'|;|--|/*|*/|@@|xp_|sp_|exec|drop|alter|create|insert|update|delete";
        }
    }
    
    # XSS Protection
    xss_protection {
        enabled true;
        sanitize_html true;
        allowed_tags "a,b,br,div,em,h1,h2,h3,h4,h5,h6,i,img,p,span,strong";
    }
    
    # File Upload Security
    file_upload {
        enabled true;
        allowed_extensions "jpg,jpeg,png,gif,mp4,webm,mov,avi";
        max_file_size "4G";
        scan_viruses true;
        check_mimetype true;
    }
}

# Rust Module Configuration for Analytics
rust_module analytics {
    # Analytics Settings
    enabled true;
    
    # Video Analytics
    video_analytics {
        track_views true;
        track_engagement true;
        track_shares true;
        track_likes true;
        track_comments true;
    }
    
    # User Analytics
    user_analytics {
        track_sessions true;
        track_devices true;
        track_locations true;
        track_browsers true;
    }
    
    # Storage Settings
    storage {
        path "/var/log/nginx/analytics";
        retention "30d";
        compression true;
        batch_size "1000";
    }
}

# Rust Module Configuration for Load Balancing
rust_module load_balancer {
    # Load Balancing Settings
    enabled true;
    
    # Backend Servers
    upstream backend {
        server 127.0.0.1:8080;
        server 127.0.0.1:8081;
        server 127.0.0.1:8082;
        
        # Load Balancing Algorithm
        least_conn;
        
        # Health Check
        health_check {
            enabled true;
            interval "30s";
            uri "/health";
            match "200";
            fall "3";
            rise "2";
        }
        
        # Session Persistence
        sticky cookie srv_id expires=1h domain=localhost path=/;
    }
    
    # Streaming Servers
    upstream streaming {
        server 127.0.0.1:1935;
        server 127.0.0.1:1936;
        
        least_conn;
    }
}

# Rust Module Configuration for Monitoring
rust_module monitor {
    # Monitoring Settings
    enabled true;
    
    # Metrics Collection
    metrics {
        enabled true;
        interval "10s";
        export_to "prometheus";
        prometheus_port "9090";
    }
    
    # Health Checks
    health_checks {
        enabled true;
        interval "30s";
        endpoints {
            "/health";
            "/metrics";
            "/api/health";
        }
    }
    
    # Performance Metrics
    performance {
        enabled true;
        track_cpu true;
        track_memory true;
        track_disk true;
        track_network true;
    }
}